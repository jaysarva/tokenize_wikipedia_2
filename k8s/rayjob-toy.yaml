apiVersion: ray.io/v1
kind: RayJob
metadata:
  name: wiki-rayjob-sample
  namespace: wiki-tokenizer
spec:
  entrypoint: >
    python -m ray_app.tokenize_wiki
    --pages-file /data/sample_pages.txt
    --output /output/token_counts.jsonl
    --tokens-dir /output/tokens
    --checkpoint /output/checkpoint.json
    --concurrency 4
  runtimeEnvYAML: |
    env_vars:
      WIKI_API_ENDPOINT: "https://en.wikipedia.org/w/api.php"
      WIKI_USER_AGENT: "tokenize-wikipedia/0.1 (contact: sarva.jay.s@gmail.com)"
  shutdownAfterJobFinishes: true
  ttlSecondsAfterFinished: 3600
  rayClusterSpec:
    rayVersion: "2.9.3"
    headGroupSpec:
      serviceType: ClusterIP
      rayStartParams:
        dashboard-host: "0.0.0.0"
        dashboard-port: "8265"
        dashboard-agent-listen-port: "52365"
        object-store-memory: "268435456"
      template:
        spec:
          containers:
            - name: ray-head
              # Update DOCKERHUB_USERNAME to your Docker Hub username
              # Or use full registry path: ghcr.io/org/tokenize-wiki:v1
              image: "docker.io/DOCKERHUB_USERNAME/tokenize-wiki:v1"
              imagePullPolicy: Always
              resources:
                requests:
                  cpu: "1"
                  memory: "1Gi"
                limits:
                  cpu: "2"
                  memory: "2.5Gi"
              env:
                - name: RAY_memory_usage_threshold
                  value: "0.99"
              volumeMounts:
                - name: wiki-pages
                  mountPath: /data
                - name: wiki-output
                  mountPath: /output
          volumes:
            - name: wiki-pages
              configMap:
                name: wiki-page-list
                optional: true
            - name: wiki-output
              persistentVolumeClaim:
                claimName: wiki-output
    workerGroupSpecs:
      - groupName: toy-workers
        # 2 workers to utilize both worker nodes (master runs head pod)
        replicas: 2
        minReplicas: 2
        maxReplicas: 4
        rayStartParams:
          object-store-memory: "268435456"
        template:
          spec:
            containers:
              - name: ray-worker
                # Update DOCKERHUB_USERNAME to your Docker Hub username
                image: "docker.io/DOCKERHUB_USERNAME/tokenize-wiki:v1"
                imagePullPolicy: Always
                resources:
                  requests:
                    cpu: "1"
                    memory: "2Gi"
                  limits:
                    cpu: "2"
                    memory: "2.5Gi"
                env:
                  - name: RAY_memory_usage_threshold
                    value: "0.99"
                volumeMounts:
                  - name: wiki-pages
                    mountPath: /data
                  - name: wiki-output
                    mountPath: /output
            volumes:
              - name: wiki-pages
                configMap:
                  name: wiki-page-list
                  optional: true
              - name: wiki-output
                persistentVolumeClaim:
                  claimName: wiki-output
